<!DOCTYPE html>
<html>
<head>
    <title>unplanned-distribution</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",getSettingsFields:function(){return[{name:"onlyshowaccepted",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Only show accepted work items."},{name:"plannedgoal",xtype:"rallynumberfield",fieldLabel:"Planned Work Goal %"},{name:"cvgoal",xtype:"rallynumberfield",fieldLabel:"Customer Voice Work Goal %"},{name:"unplannedgoal",xtype:"rallynumberfield",fieldLabel:"Unplanned Work Goal %"}]},config:{defaultSettings:{onlyshowaccepted:!1,plannedgoal:65,cvgoal:10,unplannedgoal:25}},scopeType:"release",pagesize:200,onScopeChange:function(newTimeboxScope){this.callParent(arguments),this.fetchIterations(newTimeboxScope)},fetchIterations:function(timeboxScope){this.down("rallychart")&&this.down("rallychart").destroy(),this.down("label")&&this.down("label").destroy(),this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Calculating...Please wait."}),this._myMask.show(),this.filters=[];var startDate=timeboxScope.record.raw.ReleaseStartDate,endDate=timeboxScope.record.raw.ReleaseDate,startDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:startDate}),endDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:"<",value:endDate});this.filters.push(startDateFilter),this.filters.push(endDateFilter);var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",fetch:["ObjectID","Name","StartDate","EndDate","PlanEstimate"],context:dataScope,pageSize:this.pagesize,limit:this.pagesize,sorters:[{property:"StartDate",direction:"ASC"}]},this);this.iterations=[],store.addFilter(this.filters,!1),store.loadPage(1,{scope:this,callback:function(records,operation){operation.wasSuccessful()&&(records.length>0?(_.each(records,function(record){var iterationName=record.get("Name");-1==this.iterations.indexOf(iterationName)&&this.iterations.push(iterationName)},this),this.fetchWorkItems()):0===records.length&&0===this.iterations.length&&this.showNoDataBox())}})},fetchWorkItems:function(){this.artifactStore=Ext.create("Rally.data.wsapi.artifact.Store",{models:["Defect","DefectSuite","UserStory"],fetch:["ObjectID","Name","FormattedID","PlanEstimate","Iteration","Tags","Feature"],limit:1/0},this),this.iterationFilters=[],_.each(this.iterations,function(iteration){var iterationNameFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",value:iteration});this.iterationFilters.push(iterationNameFilter)},this);var numOfIterations=this.iterationFilters.length;this.artifacts=Array(numOfIterations);for(var i=0;numOfIterations>i;i++)this.artifacts[i]=[];this.applyIterationFiltersToArtifactStore(0)},applyIterationFiltersToArtifactStore:function(i){this.artifactStore.addFilter(this.iterationFilters[i],!1);var onlyShowAccepted=this.getSetting("onlyshowaccepted");if(onlyShowAccepted){var acceptedFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:">=",value:"Accepted"});this.artifactStore.addFilter(acceptedFilter,!1)}this.artifactStore.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&(_.each(records,function(record){this.artifacts[i].push({_ref:record.get("_ref"),FormattedID:record.get("FormattedID"),Name:record.get("Name"),PlanEstimate:record.get("PlanEstimate"),IterationName:record.get("Iteration")._refObjectName,IterationRef:record.get("Iteration")._ref,Tags:record.get("Tags"),Feature:record.get("Feature")})},this),this.artifactStore.clearFilter(),this.iterationFilters.length-1>i?this.applyIterationFiltersToArtifactStore(i+1):this.prepareChart())}})},prepareChart:function(){if(this.artifacts.length>0){var series=[],categories=[],portfolioData=[],cvDefectsData=[],unplannedData=[],portfolioGoalData=[],cvDefectsGoalData=[],unplannedGoalData=[],releaseTotalPoints=0,releaseTotalPlannedPoints=0,releaseTotalCvDefectsPoints=0,releaseTotalUnplannedPoints=0,portfolioGoal=this.getSetting("plannedgoal"),cvGoal=this.getSetting("cvgoal"),unplannedGoal=this.getSetting("unplannedgoal");this.artifacts=_.filter(this.artifacts,function(artifactsPerIterationName){return 0!==artifactsPerIterationName.length}),_.each(this.artifacts,function(artifactsPerIterationName){var portfolioPoints=0,cvDefectsPoints=0,unplannedPoints=0,totalPoints=0,data=[],name=artifactsPerIterationName[0].IterationName;categories.push(name),_.each(artifactsPerIterationName,function(artifact){artifact.Feature?portfolioPoints+=artifact.PlanEstimate:_.find(artifact.Tags._tagsNameArray,function(tag){return"Customer Voice"==tag.Name})?cvDefectsPoints+=artifact.PlanEstimate:unplannedPoints+=artifact.PlanEstimate,totalPoints+=artifact.PlanEstimate},this),portfolioData.push(100*(portfolioPoints/totalPoints)),cvDefectsData.push(100*(cvDefectsPoints/totalPoints)),unplannedData.push(100*(unplannedPoints/totalPoints)),portfolioGoalData.push(portfolioGoal),cvDefectsGoalData.push(cvGoal),unplannedGoalData.push(unplannedGoal),releaseTotalPoints+=totalPoints,releaseTotalPlannedPoints+=portfolioPoints,releaseTotalCvDefectsPoints+=cvDefectsPoints,releaseTotalUnplannedPoints+=unplannedPoints},this),categories.push("Total"),portfolioData.push(100*(releaseTotalPlannedPoints/releaseTotalPoints)),cvDefectsData.push(100*(releaseTotalCvDefectsPoints/releaseTotalPoints)),unplannedData.push(100*(releaseTotalUnplannedPoints/releaseTotalPoints)),portfolioGoalData.push(portfolioGoal),cvDefectsGoalData.push(cvGoal),unplannedGoalData.push(unplannedGoal),series.push({name:"Portfolio",data:portfolioData,type:"column"}),series.push({name:"CV Defects",data:cvDefectsData,type:"column"}),series.push({name:"Unplanned",data:unplannedData,type:"column"}),series.push({name:"Portfolio Goal",data:portfolioGoalData,type:"line",lineWidth:2,marker:{enabled:!1}}),series.push({name:"CV Defects Goal",data:cvDefectsGoalData,type:"line",lineWidth:2,marker:{enabled:!1}}),series.push({name:"Unplanned Goal",data:unplannedGoalData,type:"line",lineWidth:2,marker:{enabled:!1}}),this.makeChart(series,categories)}else this.showNoDataBox()},makeChart:function(series,categories){var chart=this.add({xtype:"rallychart",chartConfig:{chart:{type:"column",zoomType:"xy"},title:{text:"Work Distribution Chart"},xAxis:{title:{text:"Iterations"}},yAxis:{title:{text:"Plan Estimates"},allowDecimals:!1,min:0,max:100},plotOptions:{column:{pointPadding:.2,borderWidth:0}}},chartData:{series:series,categories:categories}});chart.setChartColors(["#005EB8","#FF8200","#FAD200","#7CAFD7","#F6A900","#FFDD82"]),this._myMask.hide()},showNoDataBox:function(){this._myMask.hide(),this.add({xtype:"label",text:"There is no data. Check if there are iterations in scope and work items with PlanEstimate assigned for iterations"})}});

            Rally.launchApp('CustomApp', {
                name:"unplanned-distribution",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
