<!DOCTYPE html>
<html>
<head>
    <title>unplanned-distribution</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",iterations:[],iterationPageCounter:1,filters:[],pagesize:200,launch:function(){this.fetchIterations(this.getContext().getTimeboxScope())},onTimeboxScopeChange:function(newTimeboxScope){this.callParent(arguments),this.fetchIterations(newTimeboxScope)},fetchIterations:function(timeboxScope){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Calculating...Please wait."}),this._myMask.show(),this.filters=[];var startDate=timeboxScope.record.raw.ReleaseStartDate,endDate=timeboxScope.record.raw.ReleaseDate,startDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:">=",value:startDate}),endDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"StartDate",operator:"<",value:endDate});this.filters.push(startDateFilter),this.filters.push(endDateFilter),console.log(""+this.filters);var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",fetch:["ObjectID","Name","StartDate","EndDate","PlanEstimate"],context:dataScope,pageSize:this.pagesize,limit:this.pagesize,sorters:[{property:"StartDate",direction:"ASC"}]},this);this.iterations=[],store.addFilter(this.filters,!1),store.loadPage(this.iterationPageCounter,{scope:this,callback:function(records,operation){operation.wasSuccessful()?records.length>0?(_.each(records,function(record){this.iterations.push(record.get("Name"))},this),console.log(this.iterations),this.fetchWorkItems()):0===records.length&&0===this.iterations.length&&(console.log("no records!"),this.showNoDataBox()):console.log("oh,noes!")}})},fetchWorkItems:function(){this.artifactStore=Ext.create("Rally.data.wsapi.artifact.Store",{models:["Defect","DefectSuite","UserStory"],fetch:["ObjectID","Name","FormattedID","PlanEstimate","Iteration","Tags","Feature"],limit:1/0},this),this.iterationFilters=[],_.each(this.iterations,function(iteration){var filter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",value:iteration});this.iterationFilters.push(filter)},this);var numOfIterations=this.iterationFilters.length;this.artifacts=Array(numOfIterations);for(var i=0;numOfIterations>i;i++)this.artifacts[i]=[];this.applyIterationFiltersToArtifactStore(0)},applyIterationFiltersToArtifactStore:function(i){this.artifactStore.addFilter(this.iterationFilters[i],!1),this.artifactStore.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&(_.each(records,function(record){this.artifacts[i].push({_ref:record.get("_ref"),FormattedID:record.get("FormattedID"),Name:record.get("Name"),PlanEstimate:record.get("PlanEstimate"),IterationName:record.get("Iteration")._refObjectName,IterationRef:record.get("Iteration")._ref,Tags:record.get("Tags"),Feature:record.get("Feature")})},this),this.artifactStore.clearFilter(records.length),this.iterationFilters.length-1>i&&this.applyIterationFiltersToArtifactStore(i+1))}})},prepareChart:function(){if(this.artifacts.length>0){var series=[],categories=[],acceptedDuringIteration=[],acceptedOutsideIteration=[],notAccepted=[];this.artifacts=_.filter(this.artifacts,function(artifactsPerIterationName){return 0!==artifactsPerIterationName.length}),_.each(this.artifacts,function(artifactsPerIterationName){var pointsAcceptedDuringIteration=0,pointsAcceptedOutsideIteration=0,pointsNotAccepted=0,data=[],name=artifactsPerIterationName[0].IterationName;categories.push(name),_.each(artifactsPerIterationName,function(artifact){null===artifact.AcceptedDate?pointsNotAccepted+=artifact.PlanEstimate:artifact.AcceptedDate>=artifact.IterationStartDate&&artifact.AcceptedDate<=artifact.IterationEndDate?pointsAcceptedDuringIteration+=artifact.PlanEstimate:pointsAcceptedOutsideIteration+=artifact.PlanEstimate}),acceptedDuringIteration.push(pointsAcceptedDuringIteration),acceptedOutsideIteration.push(pointsAcceptedOutsideIteration),notAccepted.push(pointsNotAccepted)},this),series.push({name:"Not Accepted",data:notAccepted}),series.push({name:"Accepted Outside Iteration",data:acceptedOutsideIteration}),series.push({name:"Accepted During Iteration",data:acceptedDuringIteration}),this.makeChart(series,categories)}else this.showNoDataBox()},makeChart:function(series,categories){for(var few=3,accepted=[],numOfIterations=categories.length,lastFewAccepted=[],bestFewAccepted=[],worstFewAccepted=[],avgLast=0,avgBest=0,avgWorst=0,totalLast=0,totalBest=0,totalWorst=0,i=0;numOfIterations>i;i++)accepted.push(series[2].data[i]);var yValues=series[2].data,xValues=[];for(i=0;numOfIterations>i;i++)xValues.push(i);var lr=this.calculateTrend(yValues,xValues),minX=0,maxX=categories.length-1;series.push({name:"Trend for Accepted During Iteration",type:"line",data:[[minX,lr.slope*minX+lr.intercept],[maxX,lr.slope*maxX+lr.intercept]],marker:{enabled:!1},enableMouseTracking:!1}),lastFewAccepted=_.last(accepted,few),bestFewAccepted=_.last(accepted.sort(function(a,b){return a-b}),few),worstFewAccepted=_.last(accepted.sort(function(a,b){return b-a}),few),_.each(lastFewAccepted,function(element){totalLast+=element}),_.each(bestFewAccepted,function(element){totalBest+=element}),_.each(worstFewAccepted,function(element){totalWorst+=element}),avgLast=parseFloat(parseFloat(totalLast/few).toFixed(2)),avgBest=parseFloat(parseFloat(totalBest/few).toFixed(2)),avgWorst=parseFloat(parseFloat(totalWorst/few).toFixed(2)),Ext.ComponentQuery.query("container[itemId=stats]")[0].update("Average accepted during iteration for last 3 iterations: "+avgLast+"</br>"+"Average accepted during iteration for best 3 iterations: "+avgBest+"</br>"+"Average accepted during iteration for worst 3 iterations: "+avgWorst+"</br>"),this._myMask.hide(),this.down("#chart").add({xtype:"rallychart",chartConfig:{chart:{type:"column",zoomType:"xy"},title:{text:"Velocity Chart"},xAxis:{title:{text:"Iterations"}},yAxis:{title:{text:"Plan Estimates"},allowDecimals:!1,min:0},plotOptions:{column:{stacking:"normal"}}},chartData:{series:series,categories:categories}})},calculateTrend:function(y,x){for(var lr={},n=y.length,sum_x=0,sum_y=0,sum_xy=0,sum_xx=0,sum_yy=0,i=0;y.length>i;i++)sum_x+=x[i],sum_y+=y[i],sum_xy+=x[i]*y[i],sum_xx+=x[i]*x[i],sum_yy+=y[i]*y[i];return lr.slope=(n*sum_xy-sum_x*sum_y)/(n*sum_xx-sum_x*sum_x),lr.intercept=(sum_y-lr.slope*sum_x)/n,lr.r2=Math.pow((n*sum_xy-sum_x*sum_y)/Math.sqrt((n*sum_xx-sum_x*sum_x)*(n*sum_yy-sum_y*sum_y)),2),lr},showNoDataBox:function(){this._myMask.hide(),Ext.ComponentQuery.query("container[itemId=stats]")[0].update("There is no data. </br>Check if there are interations in scope and work items with PlanEstimate assigned for iterations")}});

            Rally.launchApp('CustomApp', {
                name:"unplanned-distribution",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
